version: 2

jobs:
    build:
        docker:
            - image: circleci/golang:1.12
        steps:
            - checkout

            - run: go test ./...

            - run: go get github.com/mitchellh/gox

            - run:
                name: Build App
                command: |
                    cd cli 

                    if [ -z $CIRCLE_TAG ] 
                    then
                        gox -os="linux" -os="windows" -ldflags "-X main.version=v0.0.0-notag.$CIRCLE_BUILD_NUM" -output "../artifacts/cstore_{{.OS}}_{{.Arch}}"
                    else
                        gox -os="linux" -os="windows" -ldflags "-X main.version=$CIRCLE_TAG.$CIRCLE_BUILD_NUM" -output "../artifacts/cstore_{{.OS}}_{{.Arch}}"
                    fi  

            - persist_to_workspace:
                root: .
                paths:
                    - artifacts/*

    publish-github-release:
        docker:
            - image: circleci/golang:1.9
        steps:
            - attach_workspace:
                at: .
            - run: cd artifacts && ls
            - run:
                name: "Publish Release on GitHub"
                command: |
                    go get github.com/tcnksm/ghr
                    ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -c ${CIRCLE_SHA1} -delete ${CIRCLE_TAG} artifacts

workflows:
  version: 2
  build-n-deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*-[a-z]*$/
      - publish-github-release:
          requires:
            - build
          filters:
            tags:
              only: /^v[0-9]+(\.[0-9]+)*-[a-z]*$/
            branches:
              ignore: /.*/
          
